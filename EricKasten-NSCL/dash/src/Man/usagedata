#!/bin/sh

# /*=========================================================================*\
# | Copyright (C) 2005 by the Board of Trustees of Michigan State University. |
# | You may use this software under the terms of the GNU public license       |
# | (GPL).  The terms of this license are described at:                       |
# | http://www.gnu.org/licenses/gpl.txt                                       |
# |                                                                           |
# | Written by: E. Kasten                                                     |
# \*=========================================================================*/


# Emit a usage message
function usage() {
  echo "Usage: usagedata [--version | --help ] <program mdata file>"
}

# Check if there's at least two command line options
if [ -z "$2" ]; then
  usage
  exit -1
fi

# Initialize booleans
let VERSION=0
let HELP=0

# Capture commandline flags
for opt in $*; do
  if [ "$opt" == "--version" ]; then
    let VERSION=1
  elif [ "$opt" == "--help" ]; then
    let HELP=1
  else
    CMD=$opt
  fi
done

# Check for the data file
if [ ! -e "$CMD" ]; then
  echo "usagedata: Cannot locate man data file \"$CMD\""
  exit -2
fi

# Get the base root name
ROOT=`basename $CMD`
ROOT=`echo $ROOT | awk -F'.' '{print $1}'`
IFDEFH=`echo $ROOT | tr '[:lower:]' '[:upper:]'`
IFDEFVER="${IFDEFH}_VERSION_H"
IFDEFHELP="${IFDEFH}_HELP_H"

# Cat out the version info
if [ $VERSION -eq 1 ]; then
  echo "#ifndef $IFDEFVER"
  echo "#define $IFDEFVER"
  echo ""
  cat $CMD | sed 's/"/\\"/g' |
  awk 'BEGIN { fnd=0; } {
    if (fnd > 0) {
      if (substr($1,1,1) == "@") {
        fnd=0;
      } else {
        printf(" \\\n  \"%s\\n\"",$0);
      }
    } else {
      if ($1 == "@VERSION") {
        fnd=1;
        printf("\n// Do not edit version_string.  Automatically generated by usagedata\n");
        printf("static const char *version_string = \"\"");
      }
    } 
  } 
  END { printf(";\n");}' 
  echo ""
  echo "#endif"
fi

# Cat out the help info
if [ $HELP -eq 1 ]; then
  echo "#ifndef $IFDEFHELP"
  echo "#define $IFDEFHELP"
  echo ""
  cat $CMD | sed 's/"/\\"/g' |
  awk 'BEGIN { fnd=0; } {
    if (fnd > 0) {
      if (substr($1,1,1) == "@") {
        fnd=0;
      } else {
        printf(" \\\n  \"%s\\n\"",$0);
      }
    } else {
      if ($1 == "@HELP") {
        fnd=1;
        printf("\n// Do not edit help_string.  Automatically generated usagedata\n");
        printf("static const char *help_string = \"\"");
      }
    } 
  } 
  END { printf(";\n");}' 
  echo ""
  echo "#endif"
fi

exit $?
