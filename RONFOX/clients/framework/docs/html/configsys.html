<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Configuration subsystem</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.15 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><a name="configsys"><h2>Configuration subsystem</h2></a>

<p>
In many cases, applications require configuration information to run correctly. For example, a readout program may need to load a set of ADC thresholds in order to manage those ADC's correctly. The application framework provides  for configuration information to be read via Tcl startup scripts.
<p>
Configuration data can be directly bound to:<ul>
<li>Single C/C++ variables or member data.<li>Slices of C/C++ arrays.</ul>
In addition, associative arrays (based on the STL Map class) can be created, and initialized via these scripts. The framwoerk provides a wide variety of  configuration policies including:<ul>
<li>Read single script.<li>Read first specified script in directory path list.<li>Read all specified scripts in a directory path list.</ul>
Once configuration requirments for an application have been determined:<ul>
<li>Create a binding for each variable, array slice, or associative array needed for the configuration.<li>Register these bindings with a CConfigurationManger object.<li>Request the CCConfiguration manager object process configuration files.</ul>
Configuration scripts can be written using the entire Tcl language. Variable bindings are allowed for data of type:<ul>
<li>Integer (int)<li>Double precision (double)<li>Boolean (bool)<li>String (char*) Each of the configuration classes is templated to support configuration for any of these types. The Configuration bindings classes are:<li><a class="el" href="classCVariableBinding.html">CVariableBinding</a> - Allows you to bind a single variable to a Tcl variable in the configuraiton script.<li><a class="el" href="classCArrayBinding.html">CArrayBinding</a> - Allows you to bind a slice of an array to a Tcl array with integer indices in the configuration script.<li><a class="el" href="classCAssocArrayBinding.html">CAssocArrayBinding</a> - Allows you to create and configue an associative array with string indices.</ul>
The example below creates all of these bindings, and manages them via a  <a class="el" href="classCConfigurationManager.html">CConfigurationManager</a> object
<p>
<div class="fragment"><pre><font class="comment">//</font>
<font class="comment">// Tests the configuration system.</font>
<font class="preprocessor">#include &lt;spectrodaq.h&gt;</font>
<font class="preprocessor">#include &lt;<a class="code" href="SpectroFramework_8h.html">SpectroFramework.h</a>&gt;</font>
<font class="preprocessor">#include &lt;iostream.h&gt;</font>
<font class="preprocessor">#include &lt;fstream.h&gt;</font>
<font class="preprocessor">#include &lt;vector&gt;</font>
<font class="preprocessor">#include &lt;string&gt;</font>
<font class="preprocessor">#include &lt;stdlib.h&gt;</font>


<font class="keyword">class </font>MyApp : <font class="keyword">public</font> DAQROCNode
{
  <font class="comment">// Single configuration variables.</font>

  <font class="keywordtype">int</font>    m_nSingle;
  <font class="keywordtype">double</font> m_fSingle;
  <font class="keywordtype">bool</font>   m_bSingle;
  <font class="keywordtype">char</font>*  m_pSingle;

  <font class="comment">// Array bindings</font>

  <font class="keywordtype">int</font>    m_nArray[100];
  <font class="keywordtype">double</font> m_fArray[100];
  <font class="keywordtype">bool</font>   m_bArray[100];
  <font class="keywordtype">char</font>*  m_pArray[100];

  <font class="comment">// pointers to associative array bindings:</font>
  <font class="comment">//</font>
  <a class="code" href="classCAssocArrayBinding.html">CAssocArrayBinding&lt;int&gt;</a>*    m_pnAssoc;
  <a class="code" href="classCAssocArrayBinding.html">CAssocArrayBinding&lt;double&gt;</a>* m_pfAssoc;
  <a class="code" href="classCAssocArrayBinding.html">CAssocArrayBinding&lt;bool&gt;</a>*   m_pbAssoc;
  <a class="code" href="classCAssocArrayBinding.html">CAssocArrayBinding&lt;char*&gt;</a>*  m_ppAssoc;  
<font class="keyword">protected</font>:
  <font class="keywordtype">int</font> operator()(<font class="keywordtype">int</font> argc, <font class="keywordtype">char</font>** argv);
  <font class="keywordtype">void</font> DumpConfig(<a class="code" href="classCConfigurationManager.html">CConfigurationManager</a>&amp; rMgr, <font class="keyword">const</font> <font class="keywordtype">char</font>* dumpfile);
};

MyApp theApplication;

<font class="keywordtype">int</font>
MyApp::operator()(<font class="keywordtype">int</font> argc, <font class="keywordtype">char</font>** pargv)
{
  <font class="comment">// Bindings for single variables:</font>

  cout &lt;&lt; <font class="stringliteral">"Binding single variables"</font> &lt;&lt; endl;
  <a class="code" href="classCVariableBinding.html">CVariableBinding&lt;int&gt;</a>    nSingle(m_nSingle, <font class="stringliteral">"Integer"</font>, 0);
  <a class="code" href="classCVariableBinding.html">CVariableBinding&lt;double&gt;</a> fSingle(m_fSingle,  <font class="stringliteral">"Float"</font> , 3.14159);
  <a class="code" href="classCVariableBinding.html">CVariableBinding&lt;bool&gt;</a>   bSingle(m_bSingle,  <font class="stringliteral">"Bool"</font>  , <font class="keyword">false</font>);
  <a class="code" href="classCVariableBinding.html">CVariableBinding&lt;char*&gt;</a>  pSingle(m_pSingle,  string(<font class="stringliteral">"Char"</font>), 
                                   (<font class="keywordtype">char</font>*)NULL);

  <font class="comment">// Bindings for arrays:</font>

  cout &lt;&lt; <font class="stringliteral">"Binding array slices"</font> &lt;&lt; endl;

  <a class="code" href="classCArrayBinding.html">CArrayBinding&lt;int&gt;</a>    nArray(m_nArray, 0, 99, <font class="stringliteral">"IArray"</font>);
  <a class="code" href="classCArrayBinding.html">CArrayBinding&lt;double&gt;</a> fArray(m_fArray, 50,99, <font class="stringliteral">"FArray"</font>);
  <a class="code" href="classCArrayBinding.html">CArrayBinding&lt;bool&gt;</a>   bArray(m_bArray, 0, 49, <font class="stringliteral">"BArray"</font>);
  <a class="code" href="classCArrayBinding.html">CArrayBinding&lt;char*&gt;</a>  cArray(m_pArray, 25,75, string(<font class="stringliteral">"SArray"</font>));

  <font class="comment">// Build a bound associative array:</font>

  cout &lt;&lt; <font class="stringliteral">"Creating associative arrays"</font> &lt;&lt; endl;

  <a class="code" href="classCAssocArrayBinding.html">CAssocArrayBinding&lt;int&gt;</a>    nAssoc(<font class="stringliteral">"IAssoc"</font>);
  <a class="code" href="classCAssocArrayBinding.html">CAssocArrayBinding&lt;double&gt;</a> fAssoc(<font class="stringliteral">"FAssoc"</font>);
  <a class="code" href="classCAssocArrayBinding.html">CAssocArrayBinding&lt;bool&gt;</a>   bAssoc(<font class="stringliteral">"BAssoc"</font>);
  <a class="code" href="classCAssocArrayBinding.html">CAssocArrayBinding&lt;char*&gt;</a>  cAssoc(string(<font class="stringliteral">"CAssoc"</font>));
  m_pnAssoc = &amp;nAssoc;
  m_pfAssoc = &amp;fAssoc;
  m_pbAssoc = &amp;bAssoc;
  m_ppAssoc = &amp;cAssoc;

  <font class="comment">// Setup the configuration object:</font>

  cout &lt;&lt; <font class="stringliteral">"Creating configuration manager and loading in bindings:"</font> &lt;&lt; endl;
  <a class="code" href="classCConfigurationManager.html">CConfigurationManager</a> configurer;

  configurer.<a class="code" href="classCConfigurationManager.html#a9">AddBinding</a>(nSingle);
  configurer.<a class="code" href="classCConfigurationManager.html#a9">AddBinding</a>(fSingle);
  configurer.<a class="code" href="classCConfigurationManager.html#a9">AddBinding</a>(bSingle);
  configurer.<a class="code" href="classCConfigurationManager.html#a9">AddBinding</a>(pSingle);

  list&lt;CTypeFreeBinding*&gt; bindlist;
  bindlist.push_back(&amp;nArray);
  bindlist.push_back(&amp;fArray);
  bindlist.push_back(&amp;bArray);
  bindlist.push_back(&amp;cArray);
  configurer.<a class="code" href="classCConfigurationManager.html#a9">AddBinding</a>(bindlist);
  configurer.<a class="code" href="classCConfigurationManager.html#a9">AddBinding</a>(nAssoc);
  configurer.<a class="code" href="classCConfigurationManager.html#a9">AddBinding</a>(fAssoc);
  configurer.<a class="code" href="classCConfigurationManager.html#a9">AddBinding</a>(bAssoc);
  configurer.<a class="code" href="classCConfigurationManager.html#a9">AddBinding</a>(cAssoc);

  <font class="comment">//  Configure from a single file:</font>

  cout &lt;&lt; <font class="stringliteral">"Reading single config file"</font> &lt;&lt; endl;

  configurer.<a class="code" href="classCConfigurationManager.html#a11">ReadConfigFile</a>(<font class="stringliteral">"config.tcl"</font>);
 
  DumpConfig(configurer, <font class="stringliteral">"SingleFile"</font>);

  <font class="comment">// Configure from first file in path list... should get same result.</font>

  cout &lt;&lt; <font class="stringliteral">"Reading 1st config file in pathlist"</font> &lt;&lt; endl;

  vector&lt;string&gt; Pathlist;
  Pathlist.push_back(string(<font class="stringliteral">"."</font>));
  Pathlist.push_back(string(getenv(<font class="stringliteral">"HOME"</font>)));
  Pathlist.push_back(string(<font class="stringliteral">".."</font>));
  configurer.<a class="code" href="classCConfigurationManager.html#a14">Read1stConfigFile</a>(Pathlist, <font class="stringliteral">"config.tcl"</font>);
  DumpConfig(configurer, <font class="stringliteral">"FirstFile"</font>);

  <font class="comment">// Configure from multiple files in path list</font>

  cout &lt;&lt; <font class="stringliteral">"Reading all config files in pathlist."</font> &lt;&lt; endl;

  configurer.<a class="code" href="classCConfigurationManager.html#a17">ReadAllConfigFiles</a>(Pathlist, <font class="stringliteral">"config.tcl"</font>);
  DumpConfig(configurer, <font class="stringliteral">"AllFiles"</font>);


}
<font class="comment">//</font>

<font class="keywordtype">void</font>
MyApp::DumpConfig(<a class="code" href="classCConfigurationManager.html">CConfigurationManager</a>&amp; rMgr, <font class="keyword">const</font> <font class="keywordtype">char</font>* dumpfile)
{
  <font class="comment">// Make the filenames:</font>

  string dumpname(dumpfile);
  string listname(dumpfile);
  dumpname += <font class="stringliteral">".tcl"</font>;
  listname += <font class="stringliteral">".txt"</font>;
  
  <font class="comment">// Do the config dump:</font>

  rMgr.<a class="code" href="classCConfigurationManager.html#a20">WriteConfigFile</a>(dumpname);

  ofstream txtfile(listname.c_str());
  txtfile &lt;&lt; <font class="stringliteral">"----------------------- single variables --------------\n"</font>;
  txtfile &lt;&lt; <font class="stringliteral">"m_nSingle = "</font> &lt;&lt; m_nSingle;
  txtfile &lt;&lt; <font class="stringliteral">" m_fSingel = "</font> &lt;&lt; m_fSingle;
  txtfile &lt;&lt; <font class="stringliteral">" m_bSingle = "</font> &lt;&lt; m_bSingle;
  txtfile &lt;&lt; <font class="stringliteral">" m_pSingle = "</font> &lt;&lt; (m_pSingle ? m_pSingle : <font class="stringliteral">"null"</font>) &lt;&lt; endl;

  txtfile &lt;&lt; <font class="stringliteral">"-------------------------- Array variables -------------\n"</font>;
  txtfile &lt;&lt; <font class="stringliteral">"index  int     double   bool     string\n"</font>;
  <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i = 0; i &lt; 100; i++) {
    txtfile &lt;&lt; i &lt;&lt; m_nArray[i] &lt;&lt; <font class="stringliteral">" "</font> &lt;&lt; m_fArray[i] &lt;&lt; <font class="stringliteral">" "</font> &lt;&lt; m_bArray[i] &lt;&lt; <font class="stringliteral">" "</font> ;
    txtfile &lt;&lt; (m_pArray[i] ? m_pArray[i] : <font class="stringliteral">"(null)"</font>) &lt;&lt; endl;

  }
  txtfile &lt;&lt; <font class="stringliteral">"----------------------- nAssoc (integer assoc array) ----\n"</font>;
  txtfile &lt;&lt; <font class="stringliteral">"Index           Value\n"</font>;
  map&lt;string,int&gt;::iterator i = m_pnAssoc-&gt;begin();
  <font class="keywordflow">while</font>(i != m_pnAssoc-&gt;end()) {
    txtfile &lt;&lt; i-&gt;first  &lt;&lt; <font class="stringliteral">" "</font> &lt;&lt; i-&gt;second &lt;&lt; endl;
    i++;
  }
  txtfile &lt;&lt; <font class="stringliteral">"----------------------fAssoc (double assoc array) ------\n"</font>;
  txtfile &lt;&lt; <font class="stringliteral">"Index           Value\n"</font>;
  map&lt;string,double&gt;::iterator f = m_pfAssoc-&gt;begin();
  <font class="keywordflow">while</font>(f != m_pfAssoc-&gt;end()) {
    txtfile &lt;&lt; f-&gt;first &lt;&lt; <font class="stringliteral">" "</font> &lt;&lt; f-&gt;second &lt;&lt; endl;
    f++;
  }
  txtfile &lt;&lt; <font class="stringliteral">"---------------------------bAssoc (Bool assoc array)-----\n"</font>;
  txtfile &lt;&lt; <font class="stringliteral">"Index           Value\n"</font>;
  map&lt;string,bool&gt;::iterator b = m_pbAssoc-&gt;begin();
  <font class="keywordflow">while</font>(b != m_pbAssoc-&gt;end()) {
    txtfile &lt;&lt; b-&gt;first &lt;&lt; <font class="stringliteral">" "</font> &lt;&lt; b-&gt;second &lt;&lt; endl;
    b++;
  }
  txtfile &lt;&lt; <font class="stringliteral">"---------------------------cAssoc (char* assoc array) ------\n"</font>;
  txtfile &lt;&lt; <font class="stringliteral">"Index           Value\n"</font>;
  map&lt;string,char*&gt;::iterator c = m_ppAssoc-&gt;begin();
  <font class="keywordflow">while</font>(c != m_ppAssoc-&gt;end()) {
    txtfile &lt;&lt; c-&gt;first &lt;&lt; <font class="stringliteral">" "</font> &lt;&lt; c-&gt;second &lt;&lt; endl;
    c++;                        
  }


  
  
}
</pre></div>
<p>
<hr><address align="right"><small>Generated on Tue Feb 4 12:35:49 2003 for Spectrodaq External Event Framework by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.15 </small></address>
</body>
</html>
