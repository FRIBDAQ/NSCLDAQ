
package require tcltest
package require ReadoutGuiClient
package require Thread
package require ui

tcltest::test pkgrequire-0 {Test that we can require the package 
} {package require ReadoutGuiRemoteControl} 1.0  

proc ReadLine {sock} {
  if {[catch {gets $sock line} len] || [eof $sock]} {
    puts "Closing client"
    catch {close $sock}
  } else {
    puts $sock "OK - $line"
  }
}

set ::StatusBar::theInstance [StatusArea .bar]

proc setup {} {
  set ::connected 0
  puts "Setup start"
  ReadoutGuiRemoteControl ::rctl
  set fd [::rctl info vars clientfd]
  set ::serv [thread::create -joinable {

    package require ReadoutGuiClient
    package require Thread 

    set ::port [readoutGUIControlPort localhost]
    set ::client [socket localhost $::port]
    chan configure $::client -blocking 0 -buffering line
    
    proc ReadLine {sock} {
      if {[catch {gets $sock line} len] || [eof $sock]} {
        puts "Closing client"
        catch {close $sock}
      } else {
        puts $sock "OK - $line"
      }
    }
    chan event $::client readable [list ReadLine $::client]

    # enter event loop
    thread::wait
  }]

  vwait $fd
  # send the main thread id to the server thread
  puts "Setup complete"
}


proc tearDown {} {
  puts "teardown start"
  thread::release $::serv 
  set ::connected 0

  puts "teardown complete"
}


tcltest::test send-0 {Test that we can send messages 
} -setup {
  setup
} -cleanup {
  tearDown
} -body {
  set res [::rctl send [list puts {hello world}]]
} -result "OK - puts {hello world}"


tcltest::cleanupTests
