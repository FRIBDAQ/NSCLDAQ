#!/usr/bin/env wish

set here [file dirname [file normalize [info script]]]
lappend auto_path $here
lappend auto_path [file join $::env(DAQROOT) TclLibs]
lappend auto_path $::env(DAQLIB)

package require cmdline

set options {
  {-module.arg ""         "name of module registered to slow-controls server \[MANDATORY\]"}
  {-host.arg "localhost"  "host running VMUSBReadout slow-controls server" }
  {-port.arg  27000       "port the slow-controls server is listening on" }
  {-ring.arg $::tcl_platform(user) "name of ring VMUSBReadout is filling" }
  {-configfile.arg "" "name of configuration file to read from to initialize the GUI" }
}

set usage " --module value ?option value? :"
array set params [::cmdline::getoptions argv $options]

if {[lindex [array get params -module] 1] eq ""} {
  puts [::cmdline::usage $options $usage]
  puts "User must pass a valid value for the --module option"
  exit
}

set module [lindex [array get params -module] 1]
set host [lindex [array get params -host] 1]
set port [lindex [array get params -port] 1]
set ring [lindex [array get params -ring] 1]
set configFile [lindex [array get params -configfile] 1]

package require gd16xlm72panel

AGD16XLM72Panel dev .gui $module $host $port

if {([string length $configFile]>0)} {
  if {[file exists $configFile]} {
    dev SetConfigFileName $configFile
    dev ReadFileGD16
  } else {
    set errmsg "User specified configuration --configfile to be $configFile, but that does not exist"
    tk_messageBox -icon error -message $errmsg
    exit 0
  }
} else {
  puts "user did not set the configuration file"
}

grid .gui  -sticky nsew
grid rowconfigure . 0 -weight 1
grid columnconfigure . 0 -weight 1


set gd16(configuration) 0xdaba0006
