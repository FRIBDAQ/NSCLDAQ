#
#    This software is Copyright by the Board of Trustees of Michigan
#    State University (c) Copyright 2005.
#
#    You may use this software under the terms of the GNU public license
#    (GPL).  The terms of this license are described at:
#
#     http://www.gnu.org/licenses/gpl.txt
#
#     Author:
#             Ron Fox
#            NSCL
#            Michigan State University
#            East Lansing, MI 48824-1321
#
#----------- Setup environment

set here [file dirname [info script]]

# starting to just get too tough to do this without
# packaging:
package require tcltest

set auto_saved $auto_path
set auto_path [concat $here $auto_path]


if {[file exists pkgIndex.tcl]} {
    file delete              pkgIndex.tcl.saved
    file rename pkgIndex.tcl pkgIndex.tcl.saved
}
pkg_mkIndex . *.tcl

#----------- Test utility procs

#   Make the standard packet.
#
proc makePacket {} {
    set description {test:0xffff:This is a test:1.2:Mon Jan 12 08:16:32 EST 2005}
    return [packetDescription standard -packet $description]

}

#----------- Tests:

::tcltest::test 1.0 {Get Name}                               \
-setup {
    makePacket
}                                                            \
-cleanup {
    standard destroy
}                                                            \
-body {
    set result [standard getName]
}                                                             \
-result {test}

::tcltest::test 1.1 {Get description}                           \
-setup {
    makePacket
}                                                             \
-cleanup {
    standard destroy
}                                                             \
-body {
    set result [standard getDescription]
}                                                           \
-result {This is a test}

::tcltest::test 1.2 {get id }                                \
-setup {
    makePacket
}                                                            \
-cleanup {
    standard destroy
}                                                           \
-body {
    set result [standard getId]
}                                                        \
-result {0xffff}

::tcltest::test 1.3 {Get Version}                       \
-setup {
    makePacket
}                                                         \
-cleanup {
    standard destroy
}                                                       \
-body {
    set result [standard getVersion]
}                                                      \
-result {1.2}

::tcltest::test 1.4 {Get the date}                    \
-setup {
    makePacket
}                                                       \
-cleanup {
    standard destroy
}                                                       \
-body {
    set timestamp [standard getTimeStamp]
    set sbtime    [clock scan "Mon Jan 12 08:16:32 EST 2005"]
    set result [expr $timestamp == $sbtime]
} \
-result {1}

##

::tcltest::test 2.0 {Bad Description:}                  \
-body {
    set result \
        [catch {packetDescription bad -packet {test:0xffff:This is a test:1.2}} msg]
    catch {bad destroy}

    list $result $msg
}                                                       \
-result {1 {Error in constructor: Bad Packet Format}}

::tcltest::test 2.1 {Invalid Timestamp}                 \
-body {
    set result \
        [catch {packetDescription bad -packet {test:0xffff:This is a test:1.1:Mon Octember 37 23:24:25 EST 2004}} msg]
    catch {bad destroy}

    list $result $msg
} \
-result {1 {Error in constructor: Invalid Timestamp}}

#----------- Test environment cleanup


file delete pkgIndex.tcl
if {[file exists pkgIndex.tcl.saved]} {
    file rename pkgIndex.tcl.saved pkgIndex.tcl
}
set auto_path $auto_saved


tcltest::cleanupTests
