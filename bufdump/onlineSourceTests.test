#----------- Setup environment

set here [file dirname [info script]]

# starting to just get too tough to do this without
# packaging:
package require tcltest

set auto_saved $auto_path
set auto_path [concat $here $auto_path]


if {[file exists pkgIndex.tcl]} {
    file delete              pkgIndex.tcl.saved
    file rename pkgIndex.tcl pkgIndex.tcl.saved
}
pkg_mkIndex . *.tcl
package require dataSources


#----------- Test utility procs



#----------- Tests:

tcltest::test 1.0 {Localhost has no daq}                 \
-body {
    onlineDataSource src -daqroot / -host localhost
    set result [catch {src open} msg]
    src destroy

    list $result $msg
}                                                           \
-result {1 {No Local DAQ Installation}}

tcltest::test 1.1 {No such remote host}                 \
-constraints unix                                     \
-body {
    onlineDataSource src -host nosuchnode.anydomain.nosuchdomain
    set result [catch {src open} msg]
    src destroy

    list $result $msg
}                                                            \
-result {1 {No Such Host}}

tcltest::test 1.2 {No Remote DAQ}                             \
-constraints unix                                             \
-body {
    onlineDataSource src -host nsclgw1.nscl.msu.edu
    set result [catch {src open} msg]
    src destroy

    list $result $msg
}                                                             \
-result {1 {No DAQ on Remote Node}}


#

tcltest::test 2.0 {Read 16 word counting buffer}                 \
-constraints unix                                            \
-match       list                                            \
-cleanup {
    stopDummySource
}                                                           \
-body {
    onlineDataSource src -buffersize 32
    src open
    startDummySource
    set buffer [src getNext]
    src close
    src destroy

    set buffer
}                                                            \
-result {0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15}


#----------- Test environment cleanup


file delete pkgIndex.tcl
if {[file exists pkgIndex.tcl.saved]} {
    file rename pkgIndex.tcl.saved pkgIndex.tcl
}
set auto_path $auto_saved


tcltest::cleanupTests
