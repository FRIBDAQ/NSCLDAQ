#!/bin/csh -f
#
#	Filename:	makefile
#
#	Purpose:	Compile the Bit 3 PCI/Nanobus device driver.
#
#	Copyright (c) 1999 by SBS Technologies, Inc.
#	All rights reserved.
#
#	$Revision$
#

##############################################################################
#
#	User configuration
#
##############################################################################
#
# Change this to the root of your kernel source tree.
#
# It must match the version of the kernel for which you are building the
# driver.   ../sys/makefile creates config.make
include ../sys/config.make

# Currently only the I386 architechure is supported.
#
# Should we add other architechures, we will create a separate macro for
# each architechure.
#  ARCH_FLAGS=$(I386_FLAGS)

##############################################################################
#
#	End configuration information
#
##############################################################################

# Need to define the architechure specific flags that are used.

I386_FLAGS=-fno-strength-reduce 
# Could put in -m486, -m586, etc if that is minimum hardware

# All the other flags that need to be added to CFLAGS
# debug line
ADDED_CFLAGS=-g -DDEBUG
# no debug line
#ADDED_CFLAGS=-DNDEBUG -DBT_INLINE

EXTRA_DEFINE=-DBT1003
CC_OPTIM=-O2

# When defined, use kgcc (Red Hat specific) rather than gcc (cc) for kernel code.
# CC = kgcc
CC = gcc

#include ../sys/config.make
BTINCLUDE=../include

# 2.4 flags
#CPPFLAGS =-I$(BTINCLUDE) -I/lib/modules/`uname -r`/build/include -I/lib/modules/`uname -r`/build/include/asm/mach-default -D__KERNEL__ -DMODULE -DEXPORT_SYMTAB $(EXTRA_DEFINE)
# 2.5+ flags
#CPPFLAGS =-I$(BTINCLUDE) -I/lib/modules/`uname -r`/build/include -I/lib/modules/`uname -r`/build/include/asm/mach-default -D__KERNEL__ -DMODULE -DEXPORT_SYMTAB $(EXTRA_DEFINE) -DKBUILD_MODNAME=btp -fno-common
# Debian 2.6?

CPPFLAGS = -I$(LINUX_SRC)/include -I$(LINUX_SRC)/include/asm-i386 -I$(LINUX_SRC)/include/asm-i386/mach-default -D__KERNEL__ -DMODULE -DEXPORT_SYMTAB $(EXTRA_DEFINE) -DKBUILD_MODNAME=btp -fno-common -I$(BTINCLUDE)

CFLAGS=$(CC_OPTIM) $(ADDED_CFLAGS) $(ARCH_FLAGS) $(SMP_FLAG) -Wall -Wstrict-prototypes

SOURCES=btp_cfg.c btp_open.c btp_rdwr.c btp_mmap.c btp_ioctl.c \
    btp_lowio.c btp_version.c btp_bind.c \
    bt_mem.c bt_mutex.c bt_event.c bt_bit.c bt_llist.c bt_delay.c bt_rwlck.c \
    bt_icbr_thread.c bt_isr.c bt_nbus.c bt_param.c bt_setup.c bt_xfer.c bt_diag.c

OBJECTS = $(SOURCES:.c=.o)

default:	../sys/btp.o

clean:
	rm -f *.o

# Rule to make dependencies files, taken directly from GNU make manual
%.d: %.c
	$(SHELL) -ec '$(CC) -MM $(CPPFLAGS) $< | sed '\''s/\($*\)\.o[ :]*/\1.o $@ : /g'\'' > $@; [ -s $@ ] || rm -f $@'


include $(SOURCES:.c=.d)

btp btp.o ../sys/btp.o: $(OBJECTS)
	$(LD) -r -o btp.o $(OBJECTS) 
	cp btp.o ../sys

.FAILED:
	@echo ""
