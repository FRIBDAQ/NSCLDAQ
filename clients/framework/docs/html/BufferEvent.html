<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Buffer arrival events</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.15 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><a name="BufferEvent"><h2>Buffer arrival events</h2></a>

<p>
The main function of the Spectrodaq server is to provide buffers of data, as requested from producers of data. The <a class="el" href="classCBufferEvent.html">CBufferEvent</a> class provides the hook to respond to buffers received asyncrhonously. Each BufferEvent class  can respond to buffers from a disjoint set of sources (links in Spectrodaq terminology).
<p>
In order to understand buffer data sources it is necessary to understand the folowing spectrodaq concepts:<ul>
<li>Link - A link is a virtual connection to a spectrodaq server in the local system or in some remote system. The link is specified by a URL of the form: TCP://hostname:2602/ where:<ol>
<li>hostname specifies the host on which the server lives e.g. localhost for buffers produced on the local system.<li>2602 is the TCP/IP port number on which the server by default listens for connection requests.</ol>
<li>Selectivity - A link can be selective of the buffers it receives in two ways:<ol>
<li>Reliability - For programs which need not see all data, the application can specify that it wants to receive data  "Unreliably" The application will then only recieve the fraction of the data it can analyze.<li>Type selection; Buffers are tagged with a longword which can be thought of as representative of their data type. A link has associated with it a tag and a mask. Links will only accept buffers where (buffer.tag &amp; link.mask) ==  link.tag In addition, buffers which receive data along a link also have tags and masks. Once the link has received the data it is only sent to the receiving buffer after similar selection logic.</ol>
</ul>
With that understanding we can now look in more detail at the <a class="el" href="classCBufferEvent.html">CBufferEvent</a> class and how to use it. To respond to spectrodaq buffers you must:<ul>
<li>Write a subclas to <a class="el" href="classCBufferEvent.html">CBufferEvent</a>.<li>The <a class="el" href="classCBufferEvent.html#a10">OnBuffer</a> must be overridden with experiment specific code to process buffers received by the object.<li>One or more instances (depending on application needs) of the class must be instantiated by the running application.<li>The instances must be started by calling their  <a class="el" href="classCEvent.html#a11">Enable()</a> member.<li>Select the buffer mask and tag using:<ol>
<li><a class="el" href="classCBufferEvent.html#a12">setBufferTag</a> and<li><a class="el" href="classCBufferEvent.html#a13">setBufferMask</a></ol>
<li>Create links for every data source desired by calling <a class="el" href="classCBufferEvent.html#a8">AddLink().</a></ul>
In the example below, a buffer event is created which listens for, and receives all buffers from the local host. When a buffer is received, the first 64 words (16 bit integers) are dumped to stdout in hex notation with just enough header text to allow us to separate the buffers.
<p>
<div class="fragment"><pre><font class="preprocessor">#include &lt;spectrodaq.h&gt;</font>
<font class="preprocessor">#include &lt;<a class="code" href="SpectroFramework_8h.html">SpectroFramework.h</a>&gt;</font>
<font class="preprocessor">#include &lt;iostream.h&gt;</font>

<font class="keyword">typedef</font> <a class="code" href="classCBufferEvent.html">CBufferEvent&lt;Word&gt;</a> WordBufferEvent;
<font class="keyword">typedef</font> Pointer&lt;DAQBuffer&lt;Word&gt;,Word&gt; WordPointer;


<font class="keyword">static</font> <font class="keyword">const</font> <font class="keywordtype">int</font> WordsToDump = 64;
<font class="keyword">static</font> <font class="keyword">const</font> <font class="keywordtype">int</font> WordsPerLine= 16;
<font class="keyword">class </font>MyBuffers : <font class="keyword">public</font> WordBufferEvent
{
  ostream&amp; m_rOutfile;
<font class="keyword">public</font>:
  MyBuffers(<font class="keyword">const</font> <font class="keywordtype">char</font>* pName, ostream&amp; routfile);
  <font class="keyword">virtual</font> <font class="keywordtype">void</font> OnBuffer(WordPointer&amp; pBuffer);
};

MyBuffers::MyBuffers(<font class="keyword">const</font> <font class="keywordtype">char</font>* pname, ostream&amp; routfile) :
  WordBufferEvent(pname),
  m_rOutfile(routfile)
{}

<font class="keywordtype">void</font>
MyBuffers::OnBuffer(WordPointer&amp; pBuffer)
{
  m_rOutfile &lt;&lt; <font class="stringliteral">"---------------------- buffer -----------------"</font>;
  m_rOutfile &lt;&lt; hex;
  <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i =0; i &lt; WordsToDump; i++) {
    <font class="keywordflow">if</font>( (i% WordsPerLine) == 0) {
      cout &lt;&lt; endl;
    }
    cout &lt;&lt; *pBuffer &lt;&lt; <font class="stringliteral">" "</font>;
    ++pBuffer;
  }
  m_rOutfile &lt;&lt; endl;

  m_rOutfile &lt;&lt; dec;
}

<font class="keyword">class </font>MyApp : <font class="keyword">public</font> DAQROCNode
{
<font class="keyword">protected</font>:
  <font class="keywordtype">int</font> operator() (<font class="keywordtype">int</font> argc, <font class="keywordtype">char</font>** argv);

};
MyApp theApplication;

<font class="keywordtype">int</font>
MyApp::operator()(<font class="keywordtype">int</font> argc, <font class="keywordtype">char</font>** argv)
{
  MyBuffers Receiver(<font class="stringliteral">"BuferReceiver"</font>, cout);
  Receiver.setBufferTag(0);
  Receiver.setBufferMask(0);
  
  Receiver.AddLink(<font class="stringliteral">"TCP://localhost:2602/"</font>, 0, 0);   <font class="comment">// Relieable, all events</font>
  Receiver.Enable();
  
  DAQThreadId id = Receiver.getThreadId();
  
  Join(id);
}

</pre></div>
<p>
<hr><address align="right"><small>Generated on Wed Feb 5 13:40:37 2003 for Spectrodaq External Event Framework by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.15 </small></address>
</body>
</html>
